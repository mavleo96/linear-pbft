syntax="proto3";

package pb;

import "google/protobuf/empty.proto";
import "google/protobuf/wrappers.proto";

option go_package = "github.com/mavleo96/bft-mavleo96/pb";

service LinearPBFTNode {
    rpc TransferRequest (SignedTransactionRequest) returns (google.protobuf.Empty);
    rpc ReadOnlyRequest (SignedTransactionRequest) returns (SignedTransactionResponse);

    rpc PrePrepareRequest (SignedPrePrepareMessage) returns (SignedPrepareMessage);
    rpc PrepareRequest (CollectedSignedPrepareMessage) returns (SignedCommitMessage);
    rpc CommitRequest (CollectedSignedCommitMessage) returns (google.protobuf.Empty);

    rpc ViewChangeRequest (SignedViewChangeMessage) returns (google.protobuf.Empty);
    rpc NewViewRequest (SignedNewViewMessage) returns (stream SignedPrepareMessage);

    rpc GetRequest (google.protobuf.Int64Value) returns (SignedTransactionRequest);
}

service LinearPBFTClientApp {
    rpc ReceiveReply (SignedTransactionResponse) returns (google.protobuf.Empty);
}

// ---------- TransactionRequest ----------

message TransactionResponse {
    int64 viewNumber = 1;
    int64 timestamp = 2;
    string sender = 3;
    string nodeID = 4;
    int64 result = 5;
}

message SignedTransactionResponse {
    TransactionResponse message = 1;
    bytes signature = 2;
}

// ---------- TransactionRequest ----------

message TransactionRequest {
    Transaction transaction = 1;
    int64 timestamp = 2;
    string sender = 3;
}

message SignedTransactionRequest {
    TransactionRequest request = 1;
    bytes signature = 2;
}

// -------------- Transaction --------------

message Transaction {
    string type = 1; 
    string sender = 2;
    string receiver = 3;
    int64 amount = 4;
}

// -------------- PrePrepare --------------

message PrePrepareMessage {
    int64 viewNumber = 1;
    int64 sequenceNum = 2;
    bytes digest = 3;
}

message SignedPrePrepareMessage {
    PrePrepareMessage message = 1;
    bytes signature = 2;
    SignedTransactionRequest request = 3;
}


// -------------- Prepare --------------

message PrepareMessage {
    int64 viewNumber = 1;
    int64 sequenceNum = 2;
    bytes digest = 3;
    string nodeID = 4;
}

message SignedPrepareMessage {
    PrepareMessage message = 1;
    bytes signature = 2;
}

message CollectedSignedPrepareMessage {
    int64 viewNumber = 1;
    int64 sequenceNum = 2;
    bytes digest = 3;
    repeated SignedPrepareMessage messages = 4;
}

// -------------- Commit --------------

message CommitMessage {
    int64 viewNumber = 1;
    int64 sequenceNum = 2;
    bytes digest = 3;
    string nodeID = 4;
}

message SignedCommitMessage {
    CommitMessage message = 1;
    bytes signature = 2;
}

message CollectedSignedCommitMessage {
    int64 viewNumber = 1;
    int64 sequenceNum = 2;
    bytes digest = 3;
    repeated SignedCommitMessage messages = 4;
}


// -------------- ViewChange --------------

// TODO: SignedPrePrepareMessage contains the original request also...not ideal
message PrepareProof {
    SignedPrePrepareMessage signedPrePrepareMessage = 1;
    repeated SignedPrepareMessage signedPrepareMessages = 2;
}

message ViewChangeMessage {
    int64 viewNumber = 1;
    int64 sequenceNum = 2;
    repeated PrepareProof preparedSet = 3;
    string nodeID = 4;
}

message SignedViewChangeMessage {
    ViewChangeMessage message = 1;
    bytes signature = 2;
}

message NewViewMessage {
    int64 viewNumber = 1;
    repeated SignedViewChangeMessage signedViewChangeMessages = 2;
    repeated SignedPrePrepareMessage signedPrePrepareMessages = 3;
}

message SignedNewViewMessage {
    NewViewMessage message = 1;
    bytes signature = 2;
}
