syntax="proto3";

package pb;

import "google/protobuf/empty.proto";
import "google/protobuf/wrappers.proto";

option go_package = "github.com/mavleo96/linear-pbft/pb";

service LinearPBFTNode {
    rpc TransferRequest (SignedTransactionRequest) returns (google.protobuf.Empty);
    rpc ReadOnlyRequest (SignedTransactionRequest) returns (SignedTransactionResponse);

    rpc PrePrepareRequest (SignedPrePrepareMessage) returns (SignedPrepareMessage);
    rpc PrepareRequest (SignedPrepareMessage) returns (SignedCommitMessage);
    rpc CommitRequest (SignedCommitMessage) returns (google.protobuf.Empty);

    rpc CheckpointRequest(SignedCheckpointMessage) returns (google.protobuf.Empty);

    rpc ViewChangeRequest (SignedViewChangeMessage) returns (google.protobuf.Empty);
    rpc NewViewRequest (SignedNewViewMessage) returns (stream SignedPrepareMessage);
    rpc GetRequest (GetRequestMessage) returns (SignedTransactionRequest);
    rpc GetCheckpoint (GetCheckpointMessage) returns (Checkpoint);

    rpc PrintLog (google.protobuf.Int64Value) returns (google.protobuf.Empty);
    rpc PrintDB (google.protobuf.Int64Value) returns (google.protobuf.Empty);
    rpc PrintStatus (StatusRequest) returns (google.protobuf.Empty);
    rpc PrintView (google.protobuf.Int64Value) returns (google.protobuf.Empty);

    rpc ReconfigureNode (ChangeStatusMessage) returns (google.protobuf.Empty);
    rpc ResetNode (ResetRequest) returns (google.protobuf.Empty);

    rpc BenchmarkRPC (SignedTransactionRequest) returns (google.protobuf.Empty);
}

service LinearPBFTClientApp {
    rpc ReceiveReply (SignedTransactionResponse) returns (google.protobuf.Empty);
}

message StatusRequest {
    int64 testSet = 1;
    int64 sequenceNum = 2;
}

message ResetRequest {
    int64 initBalance = 1;
}

// ---------- TransactionRequest ----------

message TransactionResponse {
    int64 viewNumber = 1;
    int64 timestamp = 2;
    string sender = 3;
    string nodeID = 4;
    int64 result = 5;
    
    // For compatibality with ycsb benchmarking
    map<string, bytes> resultData = 6;         // Field-value map for read operations
    repeated ScanResult scanResults = 7;       // Multiple results for scan operations
    string error = 8;                          // Error message if operation failed
}

// ScanResult represents a single scan result
message ScanResult {
    map<string, bytes> fields = 1;
}

message SignedTransactionResponse {
    TransactionResponse message = 1;
    bytes signature = 2;
}

// ---------- TransactionRequest ----------

message TransactionRequest {
    Transaction transaction = 1;
    int64 timestamp = 2;
    string sender = 3;
}

message SignedTransactionRequest {
    TransactionRequest request = 1;
    bytes signature = 2;
}

// -------------- Transaction --------------

message Transaction {
    string type = 1; 
    string sender = 2;
    string receiver = 3;
    int64 amount = 4;

    // For compatibality with ycsb benchmarking
    string table = 5;
    string key = 6;
    map<string, bytes> values = 7;
    repeated string fields = 8;
    string startKey = 9;
    int64 scanCount = 10;
}

// -------------- PrePrepare --------------

message PrePrepareMessage {
    int64 viewNumber = 1;
    int64 sequenceNum = 2;
    bytes digest = 3;
}

message SignedPrePrepareMessage {
    PrePrepareMessage message = 1;
    bytes signature = 2;
    SignedTransactionRequest request = 3;
}

// -------------- Prepare --------------

message PrepareMessage {
    int64 viewNumber = 1;
    int64 sequenceNum = 2;
    bytes digest = 3;
    string nodeID = 4;
}

message SignedPrepareMessage {
    PrepareMessage message = 1;
    bytes signature = 2;
    bytes signature2 = 3;
}

// -------------- Commit --------------

message CommitMessage {
    int64 viewNumber = 1;
    int64 sequenceNum = 2;
    bytes digest = 3;
    string nodeID = 4;
}

message SignedCommitMessage {
    CommitMessage message = 1;
    bytes signature = 2;
}

// -------------- CheckpointRequest --------------

message CheckpointMessage {
    int64 sequenceNum = 1;
    bytes digest = 2;
    string nodeID = 3;
}

message SignedCheckpointMessage {
    CheckpointMessage message = 1;
    bytes signature = 2;
}

message GetCheckpointMessage {
    int64 sequenceNum = 1;
    string nodeID = 2;
}

message Checkpoint {
    bytes digest = 1;
    map<string, int64> snapshot = 2;
}

// -------------- ViewChange --------------

message PrepareProof {
    SignedPrePrepareMessage signedPrePrepareMessage = 1;
    SignedPrepareMessage signedPrepareMessage = 2;
}

message ViewChangeMessage {
    int64 viewNumber = 1;
    int64 sequenceNum = 2;
    repeated SignedCheckpointMessage checkpointMessages = 3;
    repeated PrepareProof preparedSet = 4;
    string nodeID = 5;
}

message SignedViewChangeMessage {
    ViewChangeMessage message = 1;
    bytes signature = 2;
}

message NewViewMessage {
    int64 viewNumber = 1;
    repeated SignedViewChangeMessage signedViewChangeMessages = 2;
    repeated SignedPrePrepareMessage signedPrePrepareMessages = 3;
}

message SignedNewViewMessage {
    NewViewMessage message = 1;
    bytes signature = 2;
}

message GetRequestMessage {
    bytes digest = 1;
    string nodeID = 2;
}

// -------------- ReconfigureNode --------------

message ChangeStatusMessage {
    bool alive = 1;
    bool byzantine = 2;
    bool signAttack = 3;
    bool crashAttack = 4;
    bool darkAttack = 5;
    repeated string darkAttackNodes = 6;
    bool timeAttack = 7;
    bool equivocationAttack = 8;
    repeated string equivocationAttackNodes = 9;
}
