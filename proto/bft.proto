syntax="proto3";

package pb;

import "google/protobuf/empty.proto";

option go_package = "github.com/mavleo96/bft-mavleo96/pb";

service LinearPBFTNode {
    rpc TransferRequest (SignedTransactionRequest) returns (google.protobuf.Empty);
    rpc ReadOnlyRequest (SignedTransactionRequest) returns (SignedTransactionResponse);

    rpc PrePrepare (SignedPrePrepareMessage) returns (SignedPrepareMessage);
    rpc Prepare (CollectedSignedPrepareMessage) returns (SignedCommitMessage);
    rpc Commit (CollectedSignedCommitMessage) returns (google.protobuf.Empty);
}

service LinearPBFTClientApp {
    rpc ReceiveReply (SignedTransactionResponse) returns (google.protobuf.Empty);
}

// ---------- TransactionRequest ----------

message TransactionResponse {
    int64 viewNumber = 1;
    int64 timestamp = 2;
    string sender = 3;
    string nodeID = 4;
    int64 result = 5;
}

message SignedTransactionResponse {
    TransactionResponse message = 1;
    bytes signature = 2;
}

// ---------- TransactionRequest ----------

message TransactionRequest {
    Transaction transaction = 1;
    int64 timestamp = 2;
    string sender = 3;
}

message SignedTransactionRequest {
    TransactionRequest request = 1;
    bytes signature = 2;
}

// -------------- Transaction --------------

message Transaction {
    string type = 1; 
    string sender = 2;
    string receiver = 3;
    int64 amount = 4;
}

// -------------- PrePrepare --------------

message PrePrepareMessage {
    int64 viewNumber = 1;
    int64 sequenceNum = 2;
    bytes digest = 3;
}

message SignedPrePrepareMessage {
    PrePrepareMessage message = 1;
    bytes signature = 2;
    TransactionRequest request = 3;
}


// -------------- Prepare --------------

message PrepareMessage {
    int64 viewNumber = 1;
    int64 sequenceNum = 2;
    bytes digest = 3;
    string nodeID = 4;
}

message SignedPrepareMessage {
    PrepareMessage message = 1;
    bytes signature = 2;
}

message CollectedSignedPrepareMessage {
    int64 viewNumber = 1;
    int64 sequenceNum = 2;
    repeated SignedPrepareMessage messages = 3;
}

// -------------- Commit --------------

message CommitMessage {
    int64 viewNumber = 1;
    int64 sequenceNum = 2;
    bytes digest = 3;
    string nodeID = 4;
}

message SignedCommitMessage {
    CommitMessage message = 1;
    bytes signature = 2;
}

message CollectedSignedCommitMessage {
    int64 viewNumber = 1;
    int64 sequenceNum = 2;
    repeated SignedCommitMessage messages = 3;
}
